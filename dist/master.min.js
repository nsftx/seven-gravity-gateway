!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("master",[],t):"object"==typeof exports?exports.master=t():(e.gravity=e.gravity||{},e.gravity.gateway=e.gravity.gateway||{},e.gravity.gateway.master=t())}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var o=i[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=3)}([function(e,t){var i={debug:!1,out:function(){if(this.debug){var e=Array.prototype.slice.call(arguments),t=e.splice(0,1);console[t]?console[t].apply(this,e):console.log.apply(this,e)}}},n=function(e,t){var i=Date.now();return function(){i+t-Date.now()<0&&(e(),i=Date.now())}};e.exports={logger:i,throttle:n}},function(e,t,i){var n=i(0).logger,o={topics:{},subscribe:function(e,t){var i,o=this;return e&&"function"==typeof t?(this.topics[e]||(this.topics[e]=[]),i=this.topics[e].push(t)-1,{remove:function(){o.topics[e].splice(i,1)}}):(n.out("error","Subscribe failed - action property is invalid or missing."),!1)},once:function(e,t){var i=!1;return"function"==typeof t&&(i=this.subscribe(e,function(){t(),i.remove()})),i},unsubscribe:function(e){return this.topics[e]?(delete this.topics[e],!0):(n.out("error","Unsubscribe failed - topic "+e+" doesn´t exist"),!1)},publish:function(e,t){var i=this.findAction(e);if(!i)return n.out("error","Publish failed - topic "+e+" doesn´t exist"),!1;i.forEach(function(e){e(void 0!==t?t:{})})},clearSubscriptions:function(){this.topics={}},findAction:function(e){return this.topics.hasOwnProperty(e)?this.topics[e]:"*"!==e&&this.checkWildcardActions(e)},isSubscribed:function(e){return this.topics.hasOwnProperty(e)&&this.topics[e].length},checkWildcardActions:function(e){var t,i,n=e.split(".");if(n.pop(),n.length>0){i=n.join(".");for(var o in this.topics)if(t=new RegExp("^"+i+"\\.\\*$","g"),t.test(o))return this.topics[o];return this.checkWildcardActions(i)}return this.findAction("*")}};e.exports=o},function(e,t,i){function n(e,t,i){this.MODIFIER_KEYS={shiftKey:["Shift",16],ctrlKey:["Ctrl",17],altKey:["Alt",18,"AltGr",225],metaKey:["Meta",91]},this.config=e,this.eventCallback=t,this.eventName=i,this.addEventListeners()}var o=i(0).logger;n.prototype={addEventListeners:function(){for(var e in this.config)window.addEventListener(e,this.handleEvent.bind(this))},handleEvent:function(e){var t=e.type.toLowerCase();"click"===t?this.handleClickEvent(e):"scroll"===t?this.handleScrollEvent(e):"keyup"===t||"keydown"===t||"keypress"===t?this.handleKeyboardEvent(e):o.out("warning","Unable to dispatch event! Event "+t+" is not supported by gateway.")},handleScrollEvent:function(e){var t={action:this.eventName,event:e.type,top:window.document.body.scrollTop,left:window.document.body.scrollLeft,totalHeight:window.innerHeight,totalWidth:window.innerWidth};this.eventCallback(t)},handleClickEvent:function(e){var t={action:this.eventName,event:e.type};this.eventCallback(t)},handleKeyboardEvent:function(e){for(var t,i=e.which||e.keyCode,n=e.key||e.keyIdentifier,r=this.config[e.type],s=0;s<r.length;s++)if(t=String(r[s]),i=String(i),n=String(n),-1!==t.indexOf(i)||-1!==t.indexOf(n)){if(-1===t.indexOf("+"))return void this.keyboardEventCallback(e);var a=this.getModifierKey(t);if(a&&!0===e[a])return void this.keyboardEventCallback(e)}o.out("info","Key "+n+" is not marked for propagation.")},getModifierKey:function(e){for(var t in this.MODIFIER_KEYS)for(var i=this.MODIFIER_KEYS[t],n=0;n<i.length;n++)if(-1!==e.indexOf(i[n]))return t},keyboardEventCallback:function(e){var t={action:this.eventName,event:e.type,key:e.key||e.keyIdentifier,keyCode:e.which||e.keyCode,keyboardButton:e.code||null,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,ctrlKey:e.ctrlKey};this.eventCallback(t)}},e.exports=function(e,t,i){return e?new n(e,t,i):(o.out("info","No key bindings passed."),!1)}},function(e,t,i){e.exports=i(4)},function(e,t,i){function n(e){var t=!0;for(var i in e)e[i].frameId&&"string"==typeof e[i].frameId||(d.out("error","[GG] Master:","frameId property is invalid or missing for "+i),t=!1);return t}function o(e){if(!e)return!1;var t=e.slaves||e.products;return t&&"object"==typeof t||d.out("warn","[GG] Master:","slaves/products object is invalid or missing"),!!(!t||n(t))&&(d.out("info","[GG] Master:","Initializing"),!0)}var r=i(5),s=i(1),a=i(6),d=i(0).logger,c=i(2),l={initialized:!1,slaves:{},config:null,allowedOrigins:null,msgSender:"Master",init:function(e){var t=e.slaves||e.products;this.initialized=!0,this.config=e,this.slaves=t||{},this.setAllowedDomains(),window.addEventListener("message",this.handleMessage.bind(this))},addSlave:function(e){var t=e.slaveId||e.productId;return t&&"string"==typeof t?e.frameId&&"string"==typeof e.frameId?(delete e.slaveId,void(this.slaves[t]=e)):(d.out("error","[GG] Master:","frameId property is invalid or missing for "+e),!1):(d.out("error","[GG] Master:","slaveId/productId property is invalid or missing for "+e),!1)},removeSlave:function(e){if(!e||!this.slaves[e])return d.out("error","[GG] Master:","Passed slaveId is invalid or it doesn`t exist."),!1;delete this.slaves[e],d.out("info","[GG] Master:","slave: "+e+" succesfully removed.")},setAllowedDomains:function(){this.config&&this.config.allowedOrigins?this.allowedOrigins=this.config.allowedOrigins:this.allowedOrigins="*"},handleMessage:function(e){if(!e.data.msgSender||e.data.msgSender===this.msgSender)return!1;var t,i;return"*"!==this.allowedOrigins&&-1===this.allowedOrigins.indexOf(e.origin)?(d.out("error","[GG] Master: Message origin is not allowed"),!1):(t=new RegExp("^Master\\.","g"),i=new RegExp("^Slave\\.","g"),i.test(e.data.action)||t.test(e.data.action)?(this.handleProtectedMessage(e),!1):(d.out("info","[GG] Master: Slave message received:",e.data),void s.publish(e.data.action,e.data)))},handleProtectedMessage:function(e){var t=e.data.slaveId||e.data.productId;if(!this.slaves[t])return!1;var i=this.slaves[t],n=e.data.action.replace(".","");n=n.charAt(0).toLowerCase()+n.slice(1),this[n]?this[n](e,i):d.out("warn","[GG] Master:","Actions with domain `Master` or `Slave` are protected!")},slaveInit:function(e,t){d.out("info","[GG] Master:","Starting to load slave.",e.data),void 0!==t.autoResize&&!1===t.autoResize||a.resetFrameSize(t.frameId),t.init&&t.init(e.data),e.data.eventListeners&&c(e.data.eventListeners,this.sendMessage.bind(this,t.frameId),"Master.Event"),this.slaveLoad(t)},slaveLoad:function(e){this.sendMessage(e.frameId,{action:"Slave.Load",data:"function"==typeof e.data?e.data():e.data||{},autoResize:void 0===e.autoResize||e.autoResize})},slaveResize:function(e,t){d.out("info","[GG] Master:","Resizing slave.",e.data),a.resize(t.frameId,e)},slaveLoaded:function(e,t){if(!t.loaded)return!1;d.out("info","[GG] Master:","Slave loaded.",e.data),t.loaded(e.data)},slaveEvent:function(e){d.out("info","[GG] Master:","Slave.Event event received.",e.data),s.publish(e.data.action,e.data)},subscribe:function(e,t){return s.subscribe(e,t)},unsubscribe:function(e){return s.unsubscribe(e)},clearSubscriptions:function(){return s.clearSubscriptions()},sendMessage:function(e,t,i){var n=document.getElementById(e);if(!n)return d.out("warn","[GG] Master:","Frame "+e+" is non existent."),!1;t.msgSender=this.msgSender,r.sendMessage(n,t,i)}};e.exports=function(e){return e&&!0===e.debug&&(d.debug=!0),!l.initialized&&o(e)?(l.init(e),l):!!l.initialized&&l}},function(e,t){function i(){}i.prototype={sendMessage:function(e,t,i){var n=e.contentWindow||window,o=i||"*";n.postMessage(t,o)}},e.exports=new i},function(e,t){var i={resetFrameSize:function(e){requestAnimationFrame(function(){var t=document.getElementById(e);t&&(t.style.height=event.data.height+"px")})},resize:function(e,t){requestAnimationFrame(function(){var i=document.getElementById(e);i&&(i.style.height=t.data.height+"px")})}};e.exports=i}])});